{% extends "base.html" %}

{% block title %}Gestão de Tokens - Melhor Envio{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title mb-0">Gestão de Tokens</h2>
                <p class="text-muted mb-0">Configure e gerencie seu token de acesso do Melhor Envio</p>
            </div>
            <div class="card-body">
                <!-- Token atual -->
                <div class="mb-4" id="currentToken"
                     data-token="{{ token_melhor_envio | default('') }}"
                     data-exp="{{ token_expiration | default('') }}">
                    <h5>Token Atual</h5>
                    <div class="mb-3">
                        <label for="tokenValue" class="form-label">Token de Acesso</label>
                        <textarea id="tokenValue" rows="4" readonly class="form-control">{{ token_melhor_envio | default('Nenhum token encontrado') }}</textarea>
                    </div>
                    
                    <div class="d-flex gap-2 mb-3">
                        <button id="copyTokenBtn" type="button" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-clipboard"></i> Copiar Token
                        </button>
                        <button id="revealBtn" type="button" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-eye"></i> Selecionar
                        </button>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Expiração:</strong><br>
                        <span id="tokenExp">{{ token_expiration | default('Sem informação de expiração') }}</span>
                    </div>
                </div>

                <hr>

                <!-- Form para atualizar token -->
                <div>
                    <h5>Atualizar Token</h5>
                    <form id="updateTokenForm">
                        <div class="mb-3">
                            <label for="newToken" class="form-label">Novo Token</label>
                            <textarea id="newToken" name="token" rows="4" placeholder="Cole o token completo aqui" class="form-control"></textarea>
                            <div class="form-text">Cole aqui o token JWT fornecido pelo Melhor Envio</div>
                        </div>
                        
                        <div class="d-flex gap-2 align-items-center">
                            <button id="pasteBtn" type="button" class="btn btn-outline-secondary">
                                <i class="bi bi-clipboard-plus"></i> Colar
                            </button>
                            <button id="submitTokenBtn" type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Salvar Token
                            </button>
                            <span id="updateStatus" class="text-success ms-2" style="display:none;">
                                <i class="bi bi-check-circle"></i> Token atualizado com sucesso!
                            </span>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
    const container = document.getElementById('currentToken');
    const tokenValue = document.getElementById('tokenValue');
    const tokenExp = document.getElementById('tokenExp');
    const copyBtn = document.getElementById('copyTokenBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const newTokenInput = document.getElementById('newToken');
    const form = document.getElementById('updateTokenForm');
    const status = document.getElementById('updateStatus');
    const revealBtn = document.getElementById('revealBtn');

    // copiar token atual
    copyBtn.addEventListener('click', async ()=>{
        const t = container.dataset.token || tokenValue.value || '';
        try {
            await navigator.clipboard.writeText(t);
            copyBtn.innerHTML = '<i class="bi bi-check"></i> Copiado!';
            copyBtn.classList.remove('btn-outline-primary');
            copyBtn.classList.add('btn-success');
            setTimeout(()=> {
                copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copiar Token';
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-primary');
            }, 1500);
        } catch(e){
            alert('Não foi possível copiar: ' + e);
        }
    });

    // revelar / selecionar o conteúdo do textarea exibido
    revealBtn.addEventListener('click', ()=>{
        tokenValue.focus();
        tokenValue.select();
    });

    // colar do clipboard no textarea de edição
    pasteBtn.addEventListener('click', async ()=>{
        try{
            const text = await navigator.clipboard.readText();
            newTokenInput.value = text;
        }catch(e){
            alert('Não foi possível acessar o clipboard: ' + e);
        }
    });

    // submit por fetch para evitar redirecionamento
    form.addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        status.style.display = 'none';
        const fd = new FormData();
        fd.append('token', newTokenInput.value || '');
        
        const submitBtn = document.getElementById('submitTokenBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';
        submitBtn.disabled = true;
        
        try{
            const resp = await fetch('/api/token_melhor_envio', {
                method: 'POST',
                body: fd,
                credentials: 'same-origin',
                redirect: 'follow'
            });
            if(resp.ok || (resp.status >= 200 && resp.status < 400)){
                status.style.display = 'inline';
                // opcional: atualizar valor exibido sem recarregar
                tokenValue.textContent = newTokenInput.value;
                container.dataset.token = newTokenInput.value;
                newTokenInput.value = '';
                
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            } else {
                const text = await resp.text();
                alert('Falha ao atualizar token: ' + resp.status + '\n' + text);
            }
        }catch(err){
            alert('Erro ao enviar requisição: ' + err);
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });
})();
</script>
{% endblock %}