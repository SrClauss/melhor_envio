{% extends "base.html" %}

{% block title %}Envios Ativos - Melhor Envio{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="card-title mb-0">Envios Ativos</h2>
                    <p class="text-muted mb-0">Visualize e gerencie seus envios ativos</p>
                </div>
                <button id="refreshBtn" class="btn btn-primary" onclick="inicializar()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
            </div>
            <div class="card-body">
                <div id="loadingIndicator" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando envios...</p>
                </div>
                
                <div id="errorAlert" class="alert alert-danger" style="display: none;" role="alert">
                    <h5 class="alert-heading">Erro ao carregar envios</h5>
                    <p id="errorMessage"></p>
                </div>
                
                <div id="enviosContainer">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Clique em "Atualizar" para carregar os envios
                    </div>
                </div>
                
                <!-- Debug data (hidden by default) -->
                <div class="mt-4">
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#debugData">
                        <i class="bi bi-code"></i> Mostrar dados brutos (debug)
                    </button>
                    <div class="collapse mt-2" id="debugData">
                        <div class="card">
                            <div class="card-body">
                                <pre id="enviosData" class="mb-0" style="font-size: 0.8em; max-height: 300px; overflow-y: auto;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
var enviosAtivos = [];

function showLoading() {
    document.getElementById('loadingIndicator').style.display = 'block';
    document.getElementById('errorAlert').style.display = 'none';
    document.getElementById('refreshBtn').disabled = true;
}

function hideLoading() {
    document.getElementById('loadingIndicator').style.display = 'none';
    document.getElementById('refreshBtn').disabled = false;
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorAlert').style.display = 'block';
}

function displayEnvios(envios) {
    const container = document.getElementById('enviosContainer');
    
    if (!envios || !envios.shipments || envios.shipments.length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> 
                Nenhum envio encontrado com status "posted"
            </div>
        `;
        return;
    }

    let html = `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Status</th>
                        <th>Destinatário</th>
                        <th>Cidade</th>
                        <th>Serviço</th>
                        <th>Valor</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
    `;

    envios.shipments.forEach(envio => {
        const statusBadge = getStatusBadge(envio.status);
        html += `
            <tr>
                <td><code>${envio.id || 'N/A'}</code></td>
                <td>${statusBadge}</td>
                <td>${envio.to?.name || 'N/A'}</td>
                <td>${envio.to?.city || 'N/A'} - ${envio.to?.state_abbr || ''}</td>
                <td><small>${envio.service?.name || 'N/A'}</small></td>
                <td><strong>R$ ${envio.price || '0,00'}</strong></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="viewDetails('${envio.id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        ${envio.tracking ? `
                        <button class="btn btn-outline-info btn-sm" onclick="copyTracking('${envio.tracking}')">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i> 
                Total de envios: ${envios.shipments.length}
            </small>
        </div>
    `;
    
    container.innerHTML = html;
}

function getStatusBadge(status) {
    const statusMap = {
        'posted': 'success',
        'pending': 'warning', 
        'canceled': 'danger',
        'delivered': 'info'
    };
    const badgeClass = statusMap[status] || 'secondary';
    return `<span class="badge bg-${badgeClass}">${status}</span>`;
}

function viewDetails(envioId) {
    // Encontrar o envio nos dados carregados
    const envio = enviosAtivos.shipments?.find(e => e.id == envioId);
    if (envio) {
        const modalBody = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Informações do Envio</h6>
                    <p><strong>ID:</strong> ${envio.id}</p>
                    <p><strong>Status:</strong> ${getStatusBadge(envio.status)}</p>
                    <p><strong>Valor:</strong> R$ ${envio.price}</p>
                    ${envio.tracking ? `<p><strong>Rastreio:</strong> ${envio.tracking}</p>` : ''}
                </div>
                <div class="col-md-6">
                    <h6>Destinatário</h6>
                    <p><strong>Nome:</strong> ${envio.to?.name || 'N/A'}</p>
                    <p><strong>Endereço:</strong> ${envio.to?.address || 'N/A'}</p>
                    <p><strong>Cidade:</strong> ${envio.to?.city || 'N/A'} - ${envio.to?.state_abbr || ''}</p>
                    <p><strong>CEP:</strong> ${envio.to?.postal_code || 'N/A'}</p>
                </div>
            </div>
        `;
        
        // Criar modal dinamicamente (você pode melhorar isso)
        alert('Detalhes do envio:\n' + JSON.stringify(envio, null, 2));
    }
}

function copyTracking(tracking) {
    navigator.clipboard.writeText(tracking).then(() => {
        // Mostrar toast de sucesso (simplificado)
        alert('Código de rastreio copiado: ' + tracking);
    });
}

async function getEnviosAtivos(status) {
    try {
        const resp = await axios.get('/api/melhorenvio/shipments', {
            params: { status: status }
        });
        return resp.data;
    } catch(err) {
        console.error('Erro ao buscar envios:', err);
        throw err;
    }
}

async function inicializar() {
    showLoading();
    
    try {
        const envios = await getEnviosAtivos('posted');
        enviosAtivos = envios;
        
        // Atualizar dados brutos para debug
        document.getElementById('enviosData').textContent = JSON.stringify(envios, null, 2);
        
        // Exibir dados formatados
        displayEnvios(envios);
        
    } catch(err) {
        console.error('Erro:', err);
        showError(err?.response?.data?.error || err?.message || 'Erro desconhecido ao carregar envios');
        
        // Mostrar dados de erro no debug
        document.getElementById('enviosData').textContent = JSON.stringify({
            error: err?.message,
            response: err?.response?.data
        }, null, 2);
    } finally {
        hideLoading();
    }
}

// Auto-inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    // Não carregar automaticamente, deixar o usuário clicar
});
</script>
{% endblock %}